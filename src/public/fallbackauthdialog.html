<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <!-- Gebruik MSAL 1.x zodat de dialoog correct werkt in oudere omgevingen -->
  <script src="https://alcdn.msauth.net/lib/1.4.18/js/msal.min.js"></script>
  <title>Fallback Auth Dialog</title>
</head>
<body>
  <p>Authenticatie: even geduld...</p>
  <script>
    // Configuratie voor MSAL v1 (Implicit Flow)
    var msalConfig = {
      auth: {
        clientId: "82d99688-d922-4bfc-8d2d-e2871eb05ebd", // CLIENT_ID
        authority: "https://login.microsoftonline.com/82022306-deb0-41be-94c4-763bf46d3547",
        redirectUri: window.location.origin + "/fallbackauthdialog.html",
        navigateToLoginRequestUrl: false
      },
      cache: {
        cacheLocation: "localStorage"
      },
      system: {
        // Nodig om redirect logins toe te laten binnen een Office dialoog
        allowRedirectInIframe: true
      }
    };

    var loginRequest = {
      scopes: ["User.Read", "Sites.ReadWrite.All"]
    };

    var msalInstance = new Msal.UserAgentApplication(msalConfig);

    function sendResult(status, payload) {
      Office.onReady(function () {
        var message = { status: status };
        if (status === "success") {
          message.result = payload;
        } else {
          message.error = payload;
        }
        Office.context.ui.messageParent(JSON.stringify(message));
      });
    }

    function acquireToken(account) {
      var silentRequest = {
        scopes: loginRequest.scopes,
        account: account
      };
      msalInstance.acquireTokenSilent(silentRequest).then(function (response) {
        sendResult("success", response.accessToken);
      }).catch(function () {
        msalInstance.acquireTokenRedirect(loginRequest);
      });
    }

    msalInstance.handleRedirectCallback(function (response) {
      if (response !== null && response.account) {
        acquireToken(response.account);
      } else {
        var account = msalInstance.getAccount();
        if (account) {
          acquireToken(account);
        } else {
          msalInstance.loginRedirect(loginRequest);
        }
      }
    }, function (error) {
      console.error("MSAL-fout:", error);
      sendResult("failure", error.errorMessage || error.message || error);
    });
  </script>
</body>
</html>
